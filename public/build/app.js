"use strict";function blogController(){}function authController(e,t){var o=this;o.errorSignInMessages=e.errorSignInMessages,o.errorSignUpMessages=e.errorSignUpMessages,o.reqAuthData=e.reqData,o.signIn=function(o){e.signIn(o).then(function(){t.go("member",{userId:e.authData.id})})},o.signUp=function(o){e.signUp(o).then(function(){t.go("member",{userId:e.authData.id})})}}function chatController(e,t,o,n,s,i){function a(t){c="1",r.selectedChat.id=t,r.chatsData.chats[t]&&(r.chatsData.chats[t].Messages||e.loadMessages(t),e.cleanMsgCounter(t))}var r=this,c=1;r.chatsData=e.chatsData,r.selectChat=a,r.sendMessage=function(t){e.messageToExistChat(r.messageText,t),r.messageText=""},r.beginChat=function(){o.open({size:"sm",component:"chatBeginner"})},r.selectedChat=e.selectedChat,r.loadMessages=function(){r.chatsData.chats[r.selectedChat.id].Messages&&(c=r.chatsData.chats[r.selectedChat.id].Messages.length-1,e.loadMessages(r.selectedChat.id))},r.scrollToFunc=function(){i(function(){n.hash(c),s()},0)},t.chatId?a(t.chatId):r.selectedChat.id=""}function validateErrorsController(){var e=this;e.messages={required:"* This field is required",minlength:"* Too short value",maxlength:"* Too long value",email:"* Email is not valid",confirm:"* Passwords are not the same"},e.messageToggle=function(t){return!("confirm"===t&&Object.keys(e.errors).length>1||!e.show)}}function layoutController(e,t){var o=this;o.authData=e.authData,o.errorSignOutMessages=e.errorSignOutMessages,o.signOut=function(){e.signOut().then(function(){"editProfile"!==t.current.name&&"chat"!==t.current.name||t.go("members")})}}function memberListController(e){e.getMembers();var t=this;t.members=e.members,t.filterParams={searchOptions:["name","surname"]}}function editModalController(e){var t=this;t.blogReqData=e.reqData,t.postData={title:e.editedPost.title,text:e.editedPost.text},t.submitFunc=function(){e.editPost(e.editedPost.id,t.postData).then(function(){e.editedPost.title=t.postData.title,e.editedPost.text=t.postData.text,t.close()},t.close)}}function postListController(e,t,o){e.getPosts(t.userId);var n=this;n.posts=e.posts,n.userId=t.userId,n.removePost=function(t){var n=o.open({size:"sm",templateUrl:"build/views/blog/post-list/remove-modal.html",controllerAs:"$ctrl",controller:function(){this.removePost=function(){e.removePost(t).then(n.close)},this.close=n.close}})},n.openCreatingModal=function(){o.open({size:"sm",component:"postModal"})},n.openEdditingModal=function(t){e.editedPost=t,o.open({size:"sm",component:"editModal"})}}function postModalController(e){var t=this;t.blogReqData=e.reqData,t.submitFunc=function(){e.createPost(t.postData).then(t.close)}}function editProfileController(e,t){var o=this,n=t.cookie.get("id");e.getUserInfo(n),o.changePassword=function(t){e.changePassword(t)},o.editProfileData=function(t){e.editProfileData(t)},o.profileData=e.userInfo,o.notice=e.notice}function profileController(e,t){var o=this;e.getUserInfo(t.userId),o.errorGettingMessages=e.notice.errorGettingMessages,o.info=e.userInfo}function profileFormController(){}function noticeController(){var e=this;e.$onInit=function(){for(var t in e.notice)e.notice[t]=""}}function notificationController(e,t){var o=this;o.notifications=e.notifications,o.remove=e.remove,o.openChat=function(o,n){t.go("chat",{chatId:o}),e.remove(n)}}function chatBeginnerController(e,t,o,n){var s=this;s.sendMessage=function(){t.messageToNewChat(s.messageData.text,s.messageData.memberId).then(function(e){s.close(),o.go("chat",{chatId:e.id})})},s.members,s.userId=n.cookie.get("id"),e.getMembers().then(function(){s.members=[],e.members.forEach(function(e){var o=!1;t.chatsData.chats.forEach(function(t){t.Users.forEach(function(t){t.id!==e.id||(o=!0)})}),o||s.members.push(e)})})}function scrollTopDirective(){return{restrict:"A",scope:{handler:"&scrollTop"},link:function(e,t){t.on("scroll",function(t){0===t.target.scrollTop&&e.handler()})}}}function compareTo(){return{restrict:"A",require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,o,n){n.$validators.confirm=function(t){return t===e.otherModelValue},e.$watch("otherModelValue",function(){n.$validate()})}}}function messageModalSwitch(e,t){return{restrict:"A",scope:{member:"=sendMessageTo"},link:function(o,n){function s(){var t=this;t.sendMessage=function(n){t.sendingIsNow=!0;var s=e.getChatsByUser(o.member.id);s?e.messageToExistChat(n.text,s.id).then(function(){i.close()}):e.messageToNewChat(n.text,o.member.id).then(function(){i.close()})},t.close=function(){i.close()}}var i;n.bind("click",function(){i=t.open({templateUrl:"build/views/components/message-modal/message-modal.html",size:"sm",controller:s,controllerAs:"$ctrl"})})}}}var app=angular.module("app",["ui.router","ui.router.state.events","LocalStorageModule","ui.bootstrap","ngAnimate"]).run(["$rootScope","localStorageService",function(e,t){e.$on("$stateChangeStart",function(e,o){if(o.data&&o.data.auth){if("Anonymous"===o.data.auth&&t.cookie.get("token"))return e.preventDefault(),!1;if("Authorized"===o.data.auth&&!t.cookie.get("token"))return e.preventDefault(),!1}})}]);app.factory("memberListService",["requestService","urls",function(e,t){var o=[];return{getMembers:function(){return new Promise(function(n,s){e.sendRequest(t.members,"get").then(function(e){e.data?(o.length||Array.prototype.push.apply(o,e.data),n()):s()},function(e){s()})})},members:o}}]),app.factory("authService",["localStorageService","requestService","urls","chatService",function(e,t,o,n){function s(s,i){return new Promise(function(u,d){c.isSendingNow=!0,t.sendRequest(o.signIn,"post",null,s,a).then(function(t){c.isSendingNow=!1,t.data&&t.data.token&&t.data.id?(r.token=t.data.token,r.id=t.data.id,r.name=t.data.name,r.surname=t.data.surname,r.email=t.data.email,e.cookie.set("token",r.token),e.cookie.set("id",r.id),e.cookie.set("name",r.name),e.cookie.set("surname",r.surname),e.cookie.set("email",r.email),l.signIn="",i&&i(),n.connect(r.userId,r.token),u()):(l.signIn="Some error. Please, try sign in again.",d())},function(e){c.isSendingNow=!1,l.signIn=e,d()})})}function i(){e.cookie.remove("token"),e.cookie.remove("email"),e.cookie.remove("id"),e.cookie.remove("name"),e.cookie.remove("surname"),r.token="",r.email="",r.id="",r.name="",r.surname=""}var a={headers:{"Content-Type":"application/jsone;"}},r={token:e.cookie.get("token"),email:e.cookie.get("email"),id:e.cookie.get("id"),name:e.cookie.get("name"),surname:e.cookie.get("surname")},c={isSendingNow:!1},l={},u={};return r.token&&r.id&&n.connect(r.id,r.token).catch(i),{signIn:s,signUp:function(e){return new Promise(function(n,i){c.isSendingNow=!0,t.sendRequest(o.signUp,"post",null,e,a).then(function(e){c.isSendingNow=!1,e.config&&e.config.data?(s(JSON.parse(e.config.data),n),u.signUp=""):(u.signUp="Some error. Please, try sign up again.",i())},function(e){c.isSendingNow=!1,u.signUp=e,i()})})},signOut:function(){return new Promise(function(e,s){var a={Token:r.token};t.sendRequest(o.signOut,"post",a).then(function(){n.disconnect(),i(),e()},function(){i(),s()})})},authData:r,reqData:c,errorSignInMessages:l,errorSignOutMessages:{},errorSignUpMessages:u}}]),app.factory("chatService",["localStorageService","$rootScope","$anchorScroll","$location","notificationService","$state",function(e,t,o,n,s,i){function a(e){e.forEach(function(e){p.chats[e.id]=e})}function r(t){if(!v)return v=!0,new Promise(function(o){m.on("portionOfMessages",function(e){u(t,e),m.removeAllListeners("portionOfMessages"),v=!1,o()}),m.emit("loadMessages",{token:e.cookie.get("token"),from:p.chats[t].Messages?p.chats[t].Messages.length:0,chatId:t})})}function c(e){p.chats[e.id]=e,t.$digest()}function l(e){p.chats[e.ChatId].Messages||(p.chats[e.ChatId].Messages=[]),p.chats[e.ChatId].Messages.push(e),p.chats[e.ChatId].updatedAt=e.createdAt,t.$digest()}function u(e,o){p.chats[e]&&(p.chats[e].Messages||(p.chats[e].Messages=[]),o.forEach(function(t){p.chats[e].Messages.push(t)}),t.$digest())}function d(t){t&&p.chats[t]&&(m.emit("cleanMsgCounter",{token:e.cookie.get("token"),chatId:t}),p.chats[t].Membership.counter=0)}function h(e){p.chats[e].Membership.counter++,t.$digest()}var m,g,f,p={chats:[]},v=!1,P={};return{connect:function(){return new Promise(function(o,n){(m=io.connect({query:{token:e.cookie.get("token")}})).on("errorConnection",function(){m.removeAllListeners("errorConnection"),n()}),m.on("successConnection",function(e){a(e.chats),P.id&&p.chats[P.id]&&(r(P.id),d(P.id)),t.$digest(),m.on("messageForClient",function(e){s.add({author:e.author.name+" "+e.author.surname,text:e.text,chatId:e.ChatId}),l(e),P.id&&P.id==e.ChatId&&"chat"==i.current.name?d(e.ChatId):h(e.ChatId)}),m.on("newChatForClient",function(e){var t=e.Messages[0];s.add({author:t.author.name+" "+t.author.surname,text:t.text,chatId:t.ChatId}),e.Membership={counter:1},c(e)}),m.on("messageSended",function(e){l(e),g&&g()}),m.on("newChatCreated",function(e){e.Membership={counter:0},c(e),f&&f(e)}),m.removeAllListeners("successConnection"),o()})})},disconnect:function(){p.chats=[],m.removeAllListeners("messageForClient"),m.removeAllListeners("newChatForClient"),m.removeAllListeners("messageSended"),m.removeAllListeners("newChatCreated"),P.id="",m.emit("disconnect")},messageToNewChat:function(t,o){if(t)return new Promise(function(n){f=n,m.emit("messageToNewChat",{token:e.cookie.get("token"),text:t,recipientId:o})})},messageToExistChat:function(t,o){if(t)return new Promise(function(n){g=n,m.emit("messageToExistChat",{token:e.cookie.get("token"),text:t,chatId:o})})},getChatsByUser:function(e){var t;return p.chats.forEach(function(o){o.Users.forEach(function(n){n.id!==e||(t=o)})}),t},loadMessages:r,selectedChat:P,chatsData:p,cleanMsgCounter:d}}]),app.factory("notificationService",["$timeout","$state",function(e,t){function o(e){n.forEach(function(t,o){t.id===e&&n.splice(o,1)})}var n=[],s=0;return{notifications:n,add:function(i){"chat"!==t.current.name&&(i.id=s,n.push(i),s++,e(function(){o(i.id)},3e3))},remove:o}}]),app.factory("requestService",["$http","$q",function(e,t){return{sendRequest:function(o,n,s,i,a){var r=t.defer(),c={method:n,url:o,data:i?JSON.stringify(i):"",config:a||"",headers:s||""};return e(c).then(function(e){e&&r.resolve(e)},function(e){e&&r.reject(e.data.message)}),r.promise}}}]);var urls={blog:"http://localhost:3000/api/blog/",signIn:"http://localhost:3000/api/auth/signin/",signUp:"http://localhost:3000/api/auth/signup/",signOut:"http://localhost:3000/api/auth/logout/",members:"http://localhost:3000/api/user/",editProfile:"http://localhost:3000/api/user/edit-profile/",editPassword:"http://localhost:3000/api/user/edit-password/",post:"http://localhost:3000/api/post/",chat:"http://localhost:3000/api/chat/"};app.constant("urls",urls),app.factory("postListService",["requestService","authService","urls",function(e,t,o){var n=[],s={},i={isCreatingNow:!1,removedPost:""},a={headers:{"Content-Type":"application/jsone;"}};return{getPosts:function(t){return new Promise(function(i,a){n.splice(0,n.length),e.sendRequest(o.blog+t,"get").then(function(e){e.data?(Array.prototype.push.apply(n,e.data),s.gettingPosts="",i()):(s.gettingPosts="No available posts.",a())},function(e){s.gettingPosts=e,a()})})},posts:n,reqData:i,editedPost:{},errorMessages:s,removePost:function(a){return new Promise(function(r,c){var l={Token:t.authData.token};i.removedPost=a,e.sendRequest(o.post+a,"delete",l).then(function(){s.removingPost="";for(var e=0;e<n.length;e++)n[e].id===i.removedPost&&n.splice(e,1);r()},function(e){s.removingPost=e,c()})})},createPost:function(r){return new Promise(function(c,l){var u={Token:t.authData.token};i.isCreatingNow=!0,e.sendRequest(o.post,"post",u,r,a).then(function(e){i.isCreatingNow=!1,e.data?(n.push(e.data),s.creatingPost="",c()):(s.creatingPost="Somthing error. Please, try reload page.",l())},function(e){s.creatingPost=e,i.isCreatingNow=!1,l()})})},editPost:function(n,r){return new Promise(function(c,l){var u={Token:t.authData.token};i.isCreatingNow=!0,e.sendRequest(o.post+n,"put",u,r,a).then(function(e){i.isCreatingNow=!1,s.creatingPost="",c()},function(e){s.edditingPost=e,i.isCreatingNow=!1,l()})})}}}]),app.factory("profileService",["requestService","urls","authService","localStorageService",function(e,t,o,n){var s={},i={errorGettingMessages:{},errorProfileMessages:{},errorPasswordMessages:{},successProfileMessages:{},successPasswordMessages:{}},a={isSendingNow:!1};return{getUserInfo:function(o){return new Promise(function(){e.sendRequest(t.members+o,"get").then(function(e){e&&e.data&&(i.gettingUserInfo="",s.name=e.data.name,s.surname=e.data.surname,s.description=e.data.description,s.id=e.data.id,s.email=e.data.email)},function(e){i.errorGettingMessages=e,s.name="",s.surname="",s.description="",s.id="",s.email=""})})},editProfileData:function(s){var r={headers:{"Content-Type":"application/jsone;"}},c={Token:o.authData.token};return new Promise(function(l){a.isSendingNow=!0,e.sendRequest(t.editProfile+o.authData.id,"put",c,s,r).then(function(){o.authData.email=s.email,n.cookie.set("email",s.email),i.errorProfileMessages.editProfile="",i.successProfileMessages.editProfile="Profile is successfully edited!",a.isSendingNow=!1,l()},function(e){a.isSendingNow=!1,i.errorProfileMessages.editProfile=e,i.successProfileMessages.editProfile=""})})},changePassword:function(n){var s={headers:{"Content-Type":"application/jsone;"}},r={Token:o.authData.token};return new Promise(function(o){a.isSendingNow=!0,console.log(t.editPassword),e.sendRequest(t.editPassword,"put",r,n,s).then(function(){a.isSendingNow=!1,i.errorPasswordMessages.changePassword="",i.successPasswordMessages.changePassword="Password is successfully edited!",o()},function(e){a.isSendingNow=!1,i.errorPasswordMessages.changePassword=e,i.successPasswordMessages.changePassword=""})})},userInfo:s,notice:i,reqData:a}}]),app.filter("filter",function(){return function(e,t){if(!t.searchText)return e;var o=JSON.parse(JSON.stringify(e)),n=[],s=t.caseSensetive?t.searchText:t.searchText.toLowerCase(),i="any"!==t.searchBy?[t.searchBy]:t.searchOptions;return o.forEach(function(o,a){var r=!1;i.forEach(function(e){o[e]=t.caseSensetive?o[e]:o[e].toLowerCase(),(t.fullMatch?o[e]===s:o[e].indexOf(s)>-1)&&(r=!0)}),(r=t.negative?!r:r)&&n.push(e[a])}),n}}),app.component("blog",{templateUrl:"build/views/blog/blog.html",controller:[blogController],bindings:{authData:"<"}}),app.component("auth",{templateUrl:"build/views/auth/auth.html",controller:["authService","$state",authController]}),app.component("chat",{templateUrl:"build/views/chat/chat.html",controller:["chatService","$stateParams","$uibModal","$location","$anchorScroll","$timeout",chatController],bindings:{authData:"<"}}),app.component("validateErrors",{bindings:{errors:"<",show:"<"},template:'<div class="text-danger" ng-repeat="(key, value) in $ctrl.errors" ng-if="$ctrl.messageToggle(key)">{{$ctrl.messages[key]}}</div>',controller:[validateErrorsController]}),app.component("layout",{templateUrl:"build/views/layout/layout.html",controller:["authService","$state",layoutController]}),app.component("memberList",{templateUrl:"build/views/member-list/member-list.html",controller:["memberListService",memberListController],bindings:{authData:"<"}}),app.component("editModal",{templateUrl:"build/views/blog/post-list/post-modal.html",bindings:{close:"&"},controller:["postListService",editModalController]}),app.component("postList",{templateUrl:"build/views/blog/post-list/post-list.html",controller:["postListService","$stateParams","$uibModal",postListController],bindings:{authData:"<"}}),app.component("postModal",{templateUrl:"build/views/blog/post-list/post-modal.html",bindings:{close:"&"},controller:["postListService",postModalController]}),app.component("editProfile",{templateUrl:"build/views/blog/profile/edit-profile.html",controller:["profileService","localStorageService",editProfileController]}),app.component("profile",{templateUrl:"build/views/blog/profile/profile.html",controller:["profileService","$stateParams",profileController],bindings:{authData:"<"}}),app.component("profileForm",{bindings:{title:"@",isSendingNow:"<",profile:"<",submitFunc:"<",errors:"<"},templateUrl:"build/views/components/profile-form/profile-form.html",controller:[profileFormController]}),app.component("notice",{bindings:{notice:"=",danger:"<"},templateUrl:"build/views/components/notice/notice.html",controller:[noticeController]}),app.component("notificationMessages",{templateUrl:"build/views/components/notification/notification.html",controller:["notificationService","$state",notificationController]}),app.component("chatBeginner",{bindings:{resolve:"<",close:"&"},templateUrl:"build/views/chat/chat-beginner/chat-beginner.html",controller:["memberListService","chatService","$state","localStorageService",chatBeginnerController]}),app.directive("scrollTop",scrollTopDirective),app.directive("compareTo",compareTo),app.directive("sendMessageTo",["chatService","$uibModal",messageModalSwitch]),app.config(["$urlRouterProvider",function(e){e.otherwise("/")}]),app.config(["$stateProvider",function(e){e.state("member",{url:"/:userId",component:"blog",resolve:{authData:["authService",function(e){return e.authData}]}}),e.state("editProfile",{url:"/editProfile",component:"editProfile",data:{auth:"Authorized"}})}]),app.config(["$stateProvider",function(e){e.state("auth",{url:"/auth",component:"auth",data:{auth:"Anonymous"}})}]),app.config(["$stateProvider",function(e){e.state("chat",{url:"/chat/:chatId",component:"chat",data:{auth:"Authorized"},resolve:{authData:["authService",function(e){return e.authData}]}})}]),app.config(["$stateProvider",function(e){e.state("members",{url:"/",component:"memberList",resolve:{authData:["authService",function(e){return e.authData}]}})}]);