"use strict";var app=angular.module("app",["ui.router","ui.router.state.events","LocalStorageModule","ui.bootstrap","ngAnimate"]).run(["$rootScope","localStorageService",function(e,t){e.$on("$stateChangeStart",function(e,o){if(o.data&&o.data.auth){if("Anonymous"===o.data.auth&&t.cookie.get("token"))return e.preventDefault(),!1;if("Authorized"===o.data.auth&&!t.cookie.get("token"))return e.preventDefault(),!1}})}]);app.factory("memberListService",["requestService","urls",function(e,t){var o=[];return{getMembers:function(){return new Promise(function(n,i){e.sendRequest(t.members,"get").then(function(e){e.data?(!o.length&&Array.prototype.push.apply(o,e.data),n()):i()},function(e){i()})})},members:o}}]),app.factory("authService",["localStorageService","requestService","urls","chatService",function(e,t,o,n){var i={headers:{"Content-Type":"application/jsone;"}},s={token:e.cookie.get("token"),email:e.cookie.get("email"),id:e.cookie.get("id"),name:e.cookie.get("name"),surname:e.cookie.get("surname")},r={isSendingNow:!1},a={},c={};return s.token&&s.id&&n.connect(s.id,s.token).catch(u),{signIn:l,signUp:function(e){return new Promise(function(n,s){r.isSendingNow=!0,t.sendRequest(o.signUp,"post",null,e,i).then(function(e){r.isSendingNow=!1,e.config&&e.config.data?(l(JSON.parse(e.config.data),n),c.signUp=""):(c.signUp="Some error. Please, try sign up again.",s())},function(e){r.isSendingNow=!1,c.signUp=e,s()})})},signOut:function(){return new Promise(function(e,i){var r={Token:s.token};t.sendRequest(o.signOut,"post",r).then(function(){n.disconnect(),u(),e()},function(){u(),i()})})},authData:s,reqData:r,errorSignInMessages:a,errorSignOutMessages:{},errorSignUpMessages:c};function l(c,l){return new Promise(function(u,d){r.isSendingNow=!0,t.sendRequest(o.signIn,"post",null,c,i).then(function(t){r.isSendingNow=!1,t.data&&t.data.token&&t.data.id?(s.token=t.data.token,s.id=t.data.id,s.name=t.data.name,s.surname=t.data.surname,s.email=t.data.email,e.cookie.set("token",s.token),e.cookie.set("id",s.id),e.cookie.set("name",s.name),e.cookie.set("surname",s.surname),e.cookie.set("email",s.email),a.signIn="",l&&l(),n.connect(s.userId,s.token),u()):(a.signIn="Some error. Please, try sign in again.",d())},function(e){r.isSendingNow=!1,a.signIn=e,d()})})}function u(){e.cookie.remove("token"),e.cookie.remove("email"),e.cookie.remove("id"),e.cookie.remove("name"),e.cookie.remove("surname"),s.token="",s.email="",s.id="",s.name="",s.surname=""}}]),app.factory("chatService",["localStorageService","$rootScope","$anchorScroll","$location","notificationService",function(e,t,o,n,i){var s,r,a,c={chats:[]},l={},u={};return{connect:function(){return new Promise(function(o,n){(s=io.connect({query:{token:e.cookie.get("token")}})).on("errorConnection",function(){s.removeAllListeners("errorConnection"),n()}),s.on("successConnection",function(e){e.chats.forEach(function(e){c.chats[e.id]=e,l[e.id]=0}),void 0!==u.id&&(d(u.id),u.id=void 0),t.$digest(),s.on("messageForClient",function(e){i.add({author:e.author.name+" "+e.author.surname,text:e.text,chatId:e.ChatId}),m(e)}),s.on("newChatForClient",function(e){var t=e.Messages[0];i.add({author:t.author.name+" "+t.author.surname,text:t.text,chatId:t.ChatId}),h(e)}),s.on("messageSended",function(e){m(e),r&&r()}),s.on("newChatCreated",function(e){h(e),a&&a(e)}),s.removeAllListeners("successConnection"),o()})})},disconnect:function(){for(var e in c.chats=[],l)l[e]=0;s.removeAllListeners("messageForClient"),s.removeAllListeners("newChatForClient"),s.removeAllListeners("messageSended"),s.removeAllListeners("newChatCreated"),s.emit("disconnect")},messageToNewChat:function(t,o){if(!t)return;return new Promise(function(n){a=n,s.emit("messageToNewChat",{token:e.cookie.get("token"),text:t,recipientId:o})})},messageToExistChat:function(t,o){if(!t)return;return new Promise(function(n){r=n,s.emit("messageToExistChat",{token:e.cookie.get("token"),text:t,chatId:o})})},getChatsByUser:function(e){var t;return c.chats.forEach(function(o){o.Users.forEach(function(n){n.id!==e||(t=o)})}),t},loadMessages:d,selectedChat:u,chatsData:c};function d(i){return new Promise(function(r){s.on("portionOfMessages",function(e){!function(e,i){if(!c.chats[e])return;c.chats[e].Messages||(c.chats[e].Messages=[]);l[e]=l[e]+i.length+1,Array.prototype.push.apply(c.chats[e].Messages,i),t.$digest(),n.hash("bottom"),o()}(i,e),s.removeAllListeners("portionOfMessages"),r()}),s.emit("loadMessages",{token:e.cookie.get("token"),from:l[i],chatId:i})})}function h(e){l[e.id]=1,c.chats[e.id]=e,t.$digest()}function m(e){c.chats[e.ChatId].Messages||(c.chats[e.ChatId].Messages=[]),c.chats[e.ChatId].Messages.push(e),c.chats[e.ChatId].updatedAt=e.createdAt,t.$digest(),l[e.ChatId]++,n.hash("bottom"),o()}}]),app.factory("notificationService",["$timeout","$state",function(e,t){var o=[],n=0;return{notifications:o,add:function(s){if("chat"===t.current.name)return;s.id=n,o.push(s),n++,e(function(){i(s.id)},3e3)},remove:i};function i(e){o.forEach(function(t,n){t.id===e&&o.splice(n,1)})}}]),app.factory("requestService",["$http","$q",function(e,t){return{sendRequest:function(o,n,i,s,r){var a=t.defer(),c={method:n,url:o,data:s?JSON.stringify(s):"",config:r||"",headers:i||""};return e(c).then(function(e){e&&a.resolve(e)},function(e){e&&a.reject(e.data.message)}),a.promise}}}]);var urls={blog:"http://localhost:3000/api/blog/",signIn:"http://localhost:3000/api/auth/signin/",signUp:"http://localhost:3000/api/auth/signup/",signOut:"http://localhost:3000/api/auth/logout/",members:"http://localhost:3000/api/user/",editProfile:"http://localhost:3000/api/user/edit-profile/",editPassword:"http://localhost:3000/api/user/edit-password/",post:"http://localhost:3000/api/post/",chat:"http://localhost:3000/api/chat/"};function authController(e,t){var o=this;o.errorSignInMessages=e.errorSignInMessages,o.errorSignUpMessages=e.errorSignUpMessages,o.reqAuthData=e.reqData,o.signIn=function(o){e.signIn(o).then(function(){t.go("member",{userId:e.authData.id})})},o.signUp=function(o){e.signUp(o).then(function(){t.go("member",{userId:e.authData.id})})}}function blogController(){}function chatController(e,t,o,n,i){var s=this;function r(t){s.selectedChat=t,s.chatsData.chats.length?e.loadMessages(t):e.selectedChat.id=t,n.hash("bottom"),i()}s.chatsData=e.chatsData,s.selectChat=r,s.sendMessage=function(t){e.messageToExistChat(s.messageText,t),s.messageText=""},s.beginChat=function(){o.open({size:"sm",component:"chatBeginner"})},r(t.chatId)}function validateErrorsController(){var e=this;e.messages={required:"* This field is required",minlength:"* Too short value",maxlength:"* Too long value",email:"* Email is not valid",confirm:"* Passwords are not the same"},e.messageToggle=function(t){return!("confirm"===t&&Object.keys(e.errors).length>1||!e.show)}}function layoutController(e,t){this.authData=e.authData,this.errorSignOutMessages=e.errorSignOutMessages,this.signOut=function(){e.signOut().then(function(){"editProfile"!==t.current.name&&"chat"!==t.current.name||t.go("members")})}}function memberListController(e){e.getMembers();this.members=e.members,this.filterParams={searchOptions:["name","surname"]}}function editModalController(e){var t=this;t.blogReqData=e.reqData,t.postData={title:e.editedPost.title,text:e.editedPost.text},t.submitFunc=function(){e.editPost(e.editedPost.id,t.postData).then(function(){e.editedPost.title=t.postData.title,e.editedPost.text=t.postData.text,t.close()},t.close)}}function postListController(e,t,o){e.getPosts(t.userId);var n=this;n.posts=e.posts,n.userId=t.userId,n.removePost=function(t){var n=o.open({size:"sm",templateUrl:"build/views/blog/post-list/remove-modal.html",controllerAs:"$ctrl",controller:function(){this.removePost=function(){e.removePost(t).then(n.close)},this.close=n.close}})},n.openCreatingModal=function(){o.open({size:"sm",component:"postModal"})},n.openEdditingModal=function(t){e.editedPost=t,o.open({size:"sm",component:"editModal"})}}function postModalController(e){var t=this;t.blogReqData=e.reqData,t.submitFunc=function(){e.createPost(t.postData).then(t.close)}}function editProfileController(e,t){var o=t.cookie.get("id");e.getUserInfo(o),this.changePassword=function(t){e.changePassword(t)},this.editProfileData=function(t){e.editProfileData(t)},this.profileData=e.userInfo,this.notice=e.notice}function profileController(e,t){e.getUserInfo(t.userId),this.errorGettingMessages=e.notice.errorGettingMessages,this.info=e.userInfo}function chatBeginnerController(e,t,o){var n=this;n.sendMessage=function(){t.messageToNewChat(n.messageData.text,n.messageData.memberId).then(function(e){n.close(),o.go("chat",{chatId:e.id})})},n.members,e.getMembers().then(function(){n.members=[],e.members.forEach(function(e){var o=!1;t.chatsData.chats.forEach(function(t){t.Users.forEach(function(t){t.id===e.id&&(o=!0)})}),o||n.members.push(e)})})}function noticeController(){var e=this;e.$onInit=function(){for(var t in e.notice)e.notice[t]=""}}function notificationController(e,t){this.notifications=e.notifications,this.remove=e.remove,this.openChat=function(o,n){t.go("chat",{chatId:o}),e.remove(n)}}function profileFormController(){}function compareTo(){return{restrict:"A",require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,o,n){n.$validators.confirm=function(t){return t===e.otherModelValue},e.$watch("otherModelValue",function(){n.$validate()})}}}function messageModalSwitch(e,t){return{restrict:"A",scope:{member:"=sendMessageTo"},link:function(o,n){var i;function s(){var t=this;t.sendMessage=function(n){t.sendingIsNow=!0;var s=e.getChatsByUser(o.member.id);s?e.messageToExistChat(n.text,s.id).then(function(){i.close()}):e.messageToNewChat(n.text,o.member.id).then(function(){i.close()})},t.close=function(){i.close()}}n.bind("click",function(){i=t.open({templateUrl:"build/views/components/message-modal/message-modal.html",size:"sm",controller:s,controllerAs:"$ctrl"})})}}}app.constant("urls",urls),app.factory("postListService",["requestService","authService","urls",function(e,t,o){var n=[],i={},s={isCreatingNow:!1,removedPost:""},r={headers:{"Content-Type":"application/jsone;"}};return{getPosts:function(t){return new Promise(function(s,r){n.splice(0,n.length),e.sendRequest(o.blog+t,"get").then(function(e){e.data?(Array.prototype.push.apply(n,e.data),i.gettingPosts="",s()):(i.gettingPosts="No available posts.",r())},function(e){i.gettingPosts=e,r()})})},posts:n,reqData:s,editedPost:{},errorMessages:i,removePost:function(r){return new Promise(function(a,c){var l={Token:t.authData.token};s.removedPost=r,e.sendRequest(o.post+r,"delete",l).then(function(){i.removingPost="";for(var e=0;e<n.length;e++)n[e].id===s.removedPost&&n.splice(e,1);a()},function(e){i.removingPost=e,c()})})},createPost:function(a){return new Promise(function(c,l){var u={Token:t.authData.token};s.isCreatingNow=!0,e.sendRequest(o.post,"post",u,a,r).then(function(e){s.isCreatingNow=!1,e.data?(n.push(e.data),i.creatingPost="",c()):(i.creatingPost="Somthing error. Please, try reload page.",l())},function(e){i.creatingPost=e,s.isCreatingNow=!1,l()})})},editPost:function(n,a){return new Promise(function(c,l){var u={Token:t.authData.token};s.isCreatingNow=!0,e.sendRequest(o.post+n,"put",u,a,r).then(function(e){s.isCreatingNow=!1,i.creatingPost="",c()},function(e){i.edditingPost=e,s.isCreatingNow=!1,l()})})}}}]),app.factory("profileService",["requestService","urls","authService","localStorageService",function(e,t,o,n){var i={},s={errorGettingMessages:{},errorProfileMessages:{},errorPasswordMessages:{},successProfileMessages:{},successPasswordMessages:{}},r={isSendingNow:!1};return{getUserInfo:function(o){return new Promise(function(){e.sendRequest(t.members+o,"get").then(function(e){e&&e.data&&(s.gettingUserInfo="",i.name=e.data.name,i.surname=e.data.surname,i.description=e.data.description,i.id=e.data.id,i.email=e.data.email)},function(e){s.errorGettingMessages=e,i.name="",i.surname="",i.description="",i.id="",i.email=""})})},editProfileData:function(i){var a={headers:{"Content-Type":"application/jsone;"}},c={Token:o.authData.token};return new Promise(function(l){r.isSendingNow=!0,e.sendRequest(t.editProfile+o.authData.id,"put",c,i,a).then(function(){o.authData.email=i.email,n.cookie.set("email",i.email),s.errorProfileMessages.editProfile="",s.successProfileMessages.editProfile="Profile is successfully edited!",r.isSendingNow=!1,l()},function(e){r.isSendingNow=!1,s.errorProfileMessages.editProfile=e,s.successProfileMessages.editProfile=""})})},changePassword:function(n){var i={headers:{"Content-Type":"application/jsone;"}},a={Token:o.authData.token};return new Promise(function(o){r.isSendingNow=!0,console.log(t.editPassword),e.sendRequest(t.editPassword,"put",a,n,i).then(function(){r.isSendingNow=!1,s.errorPasswordMessages.changePassword="",s.successPasswordMessages.changePassword="Password is successfully edited!",o()},function(e){r.isSendingNow=!1,s.errorPasswordMessages.changePassword=e,s.successPasswordMessages.changePassword=""})})},userInfo:i,notice:s,reqData:r}}]),app.filter("filter",function(){return function(e,t){if(!t.searchText)return e;var o=JSON.parse(JSON.stringify(e)),n=[],i=t.caseSensetive?t.searchText:t.searchText.toLowerCase(),s="any"!==t.searchBy?[t.searchBy]:t.searchOptions;return o.forEach(function(o,r){var a=!1;s.forEach(function(e){o[e]=t.caseSensetive?o[e]:o[e].toLowerCase(),(t.fullMatch?o[e]===i:o[e].indexOf(i)>-1)&&(a=!0)}),(a=t.negative?!a:a)&&n.push(e[r])}),n}}),app.component("auth",{templateUrl:"build/views/auth/auth.html",controller:["authService","$state",authController]}),app.component("blog",{templateUrl:"build/views/blog/blog.html",controller:[blogController],bindings:{authData:"<"}}),app.component("chat",{templateUrl:"build/views/chat/chat.html",controller:["chatService","$stateParams","$uibModal","$location","$anchorScroll",chatController],bindings:{authData:"<"}}),app.component("validateErrors",{bindings:{errors:"<",show:"<"},template:'<div class="text-danger" ng-repeat="(key, value) in $ctrl.errors" ng-if="$ctrl.messageToggle(key)">{{$ctrl.messages[key]}}</div>',controller:[validateErrorsController]}),app.component("layout",{templateUrl:"build/views/layout/layout.html",controller:["authService","$state",layoutController]}),app.component("memberList",{templateUrl:"build/views/member-list/member-list.html",controller:["memberListService",memberListController],bindings:{authData:"<"}}),app.component("editModal",{templateUrl:"build/views/blog/post-list/post-modal.html",bindings:{close:"&"},controller:["postListService",editModalController]}),app.component("postList",{templateUrl:"build/views/blog/post-list/post-list.html",controller:["postListService","$stateParams","$uibModal",postListController],bindings:{authData:"<"}}),app.component("postModal",{templateUrl:"build/views/blog/post-list/post-modal.html",bindings:{close:"&"},controller:["postListService",postModalController]}),app.component("editProfile",{templateUrl:"build/views/blog/profile/edit-profile.html",controller:["profileService","localStorageService",editProfileController]}),app.component("profile",{templateUrl:"build/views/blog/profile/profile.html",controller:["profileService","$stateParams",profileController],bindings:{authData:"<"}}),app.component("chatBeginner",{bindings:{resolve:"<",close:"&"},templateUrl:"build/views/chat/chat-beginner/chat-beginner.html",controller:["memberListService","chatService","$state",chatBeginnerController]}),app.component("notice",{bindings:{notice:"=",danger:"<"},templateUrl:"build/views/components/notice/notice.html",controller:[noticeController]}),app.component("notificationMessages",{templateUrl:"build/views/components/notification/notification.html",controller:["notificationService","$state",notificationController]}),app.component("profileForm",{bindings:{title:"@",isSendingNow:"<",profile:"<",submitFunc:"<",errors:"<"},templateUrl:"build/views/components/profile-form/profile-form.html",controller:[profileFormController]}),app.directive("compareTo",compareTo),app.directive("sendMessageTo",["chatService","$uibModal",messageModalSwitch]),app.config(["$urlRouterProvider",function(e){e.otherwise("/")}]),app.config(["$stateProvider",function(e){e.state("auth",{url:"/auth",component:"auth",data:{auth:"Anonymous"}})}]),app.config(["$stateProvider",function(e){e.state("member",{url:"/:userId",component:"blog",resolve:{authData:["authService",function(e){return e.authData}]}}),e.state("editProfile",{url:"/editProfile",component:"editProfile",data:{auth:"Authorized"}})}]),app.config(["$stateProvider",function(e){e.state("chat",{url:"/chat/:chatId",component:"chat",data:{auth:"Authorized"},resolve:{authData:["authService",function(e){return e.authData}]}})}]),app.config(["$stateProvider",function(e){e.state("members",{url:"/",component:"memberList",resolve:{authData:["authService",function(e){return e.authData}]}})}]);